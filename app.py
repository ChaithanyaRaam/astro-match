# -*- coding: utf-8 -*-
"""astroapp

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/13q3GV6y5JpkHr5DvJ_cGCY695OmuZU6u
"""

import streamlit as st
import swisseph as swe
from geopy.geocoders import Nominatim
from datetime import datetime
from timezonefinder import TimezoneFinder
import pytz

# --- PAGE CONFIGURATION ---
st.set_page_config(
    page_title="Vedic Marriage Match",
    layout="centered"
)

# --- 1. CORE LOGIC ENGINE ---
class VedicMatchEngine:
    def __init__(self):
        swe.set_ephe_path('') # Use built-in defaults

        # --- Reference Tables ---
        self.nak_to_nadi = [0,1,2,2,1,0,0,1,2, 0,1,2,2,1,0,0,1,2, 0,1,2,2,1,0,0,1,2]
        self.nak_to_gana = [0,1,2,1,0,1,0,0,0, 2,1,1,2,2,2,2,0,0, 2,1,1,0,2,2,1,0,0]
        self.rashi_lords = [2, 5, 3, 1, 0, 3, 5, 2, 4, 6, 6, 4]

        # Yoni Matrix
        self.nak_to_yoni = [0,1,2,3,3,4,5,2,5, 6,6,7,8,9,8,9,10,10, 4,11,13,11,12,0,12,7,1]
        self.yoni_matrix = [
            [4, 2, 2, 3, 2, 2, 2, 1, 0, 1, 3, 2, 0, 2], [2, 4, 3, 3, 2, 2, 2, 2, 3, 1, 2, 3, 0, 2],
            [2, 3, 4, 2, 1, 2, 1, 3, 3, 1, 2, 0, 3, 3], [3, 3, 2, 4, 2, 1, 1, 1, 1, 2, 2, 2, 0, 0],
            [2, 2, 1, 2, 4, 2, 1, 2, 2, 1, 0, 2, 1, 1], [2, 2, 2, 1, 2, 4, 0, 2, 2, 1, 2, 3, 3, 2],
            [2, 2, 1, 1, 1, 0, 4, 2, 2, 2, 2, 2, 1, 2], [1, 2, 3, 1, 2, 2, 2, 4, 3, 0, 3, 2, 2, 1],
            [0, 3, 3, 1, 2, 2, 2, 3, 4, 1, 2, 3, 2, 2], [1, 1, 1, 2, 1, 1, 2, 0, 1, 4, 1, 1, 2, 1],
            [3, 2, 2, 2, 0, 2, 2, 3, 2, 1, 4, 2, 2, 2], [2, 3, 0, 2, 2, 3, 2, 2, 3, 1, 2, 4, 2, 2],
            [0, 0, 3, 0, 1, 3, 1, 2, 2, 2, 2, 2, 4, 2], [2, 2, 3, 0, 1, 2, 2, 1, 2, 1, 2, 2, 2, 4]
        ]

        # Maitri Matrix
        self.maitri_matrix = [
             [5, 5, 5, 4, 5, 0, 0], [5, 5, 4, 1, 4, 0.5, 0.5], [5, 4, 5, 0.5, 5, 3, 0.5],
             [4, 1, 0.5, 5, 0.5, 5, 4], [5, 4, 5, 0.5, 5, 0.5, 3], [0, 0.5, 3, 5, 0.5, 5, 5],
             [0, 0.5, 0.5, 4, 3, 5, 5]
        ]

    def get_planet_data(self, dt_obj, lat, lon):
        # 1. FIND TIMEZONE FROM LAT/LON
        tf = TimezoneFinder()
        timezone_str = tf.timezone_at(lng=lon, lat=lat)

        if timezone_str is None:
            timezone_str = 'UTC'

        # 2. CONVERT LOCAL TIME TO UTC
        local_tz = pytz.timezone(timezone_str)
        local_dt = local_tz.localize(dt_obj)
        utc_dt = local_dt.astimezone(pytz.utc)

        # 3. CALCULATE PLANETS
        time_dec = utc_dt.hour + (utc_dt.minute / 60.0) + (utc_dt.second / 3600.0)
        jd = swe.julday(utc_dt.year, utc_dt.month, utc_dt.day, time_dec)
        swe.set_sid_mode(swe.SIDM_LAHIRI, 0, 0)

        moon_deg = swe.calc_ut(jd, 1, swe.FLG_SIDEREAL)[0][0]
        mars_deg = swe.calc_ut(jd, 4, swe.FLG_SIDEREAL)[0][0]

        return {
            "nakshatra": int(moon_deg / 13.333333),
            "rashi": int(moon_deg / 30),
            "mars_house": (int(mars_deg/30) - int(moon_deg/30) + 12) % 12 + 1,
            "timezone_used": timezone_str
        }

    def calculate_match(self, boy, girl):
        scores = {}
        # Calculations
        scores['Varna'] = 1
        scores['Vashya'] = 2
        dist = (girl['nakshatra'] - boy['nakshatra'] + 27) % 27
        scores['Tara'] = 3 if (dist % 9) not in [0,2,4,6] else 1.5
        scores['Yoni'] = self.yoni_matrix[self.nak_to_yoni[boy['nakshatra']]][self.nak_to_yoni[girl['nakshatra']]]
        scores['Maitri'] = (self.maitri_matrix[self.rashi_lords[boy['rashi']]][self.rashi_lords[girl['rashi']]] +
                            self.maitri_matrix[self.rashi_lords[girl['rashi']]][self.rashi_lords[boy['rashi']]]) / 2
        bg, gg = self.nak_to_gana[boy['nakshatra']], self.nak_to_gana[girl['nakshatra']]
        scores['Gana'] = 6 if bg == gg else (0 if {bg, gg} == {0, 2} else 5)
        dist_r = (girl['rashi'] - boy['rashi'] + 12) % 12
        scores['Bhakoot'] = 7 if dist_r in [0, 2, 3, 6, 9, 10] else 0
        scores['Nadi'] = 0 if self.nak_to_nadi[boy['nakshatra']] == self.nak_to_nadi[girl['nakshatra']] else 8

        total = sum(scores.values())
        b_mang = boy['mars_house'] in [1, 2, 4, 7, 8, 12]
        g_mang = girl['mars_house'] in [1, 2, 4, 7, 8, 12]

        return total, scores, b_mang, g_mang

# --- 2. LOCATION UTILS ---
@st.cache_data
def get_coords(city_name):
    geolocator = Nominatim(user_agent="astro_app_final_v9", timeout=10)
    try:
        location = geolocator.geocode(city_name)
        if location:
            return location.latitude, location.longitude
        return None, None
    except:
        return None, None

# --- 3. STREAMLIT UI ---
st.title("Vedic Marriage Match")
st.markdown("### Compatibility Checker - powered by Yugma's Intelligence")
st.caption("Enter birth details below. Location is time-zone sensitive for accuracy.")

# Allowed Date Range
min_date = datetime(1900, 1, 1)
max_date = datetime(2100, 12, 31)

col1, col2 = st.columns(2)

with col1:
    st.header("Boy's Details")
    b_name = st.text_input("Name", "Rahul", key="b_name")
    b_date = st.date_input("Date of Birth", value=None, min_value=min_date, max_value=max_date, key="b_date")
    b_time = st.time_input("Time of Birth", value=None, key="b_time")
    b_place = st.text_input("Place of Birth", "Delhi, India", key="b_place")

with col2:
    st.header("Girl's Details")
    g_name = st.text_input("Name", "Priya", key="g_name")
    g_date = st.date_input("Date of Birth", value=None, min_value=min_date, max_value=max_date, key="g_date")
    g_time = st.time_input("Time of Birth", value=None, key="g_time")
    g_place = st.text_input("Place of Birth", "Mumbai, India", key="g_place")

if st.button("Check Compatibility", type="primary"):
    if b_date and b_time and g_date and g_time:

        # --- VALIDATION ---
        with st.spinner("Checking locations..."):
            b_lat, b_lon = get_coords(b_place)
            g_lat, g_lon = get_coords(g_place)

            if b_lat is None:
                st.error(f"Location not found: '{b_place}'. Please check spelling or try 'Adoor, India'.")
                st.stop()
            if g_lat is None:
                st.error(f"Location not found: '{g_place}'. Please check spelling.")
                st.stop()

        # --- CALCULATION ---
        with st.spinner("Analyzing stars & timezones..."):
            b_dt = datetime.combine(b_date, b_time)
            g_dt = datetime.combine(g_date, g_time)

            engine = VedicMatchEngine()
            b_data = engine.get_planet_data(b_dt, b_lat, b_lon)
            g_data = engine.get_planet_data(g_dt, g_lat, g_lon)

            total, breakdown, b_mang, g_mang = engine.calculate_match(b_data, g_data)

        # --- LAYMAN INTERPRETATION ---
        # 1. Verdict Text
        if total > 24:
            verdict_short = "Excellent Match"
            verdict_desc = "Strong planetary support for a happy life."
            color = "green"
        elif total >= 18:
            verdict_short = "Good Match"
            verdict_desc = "Stable and compatible. A solid foundation for marriage."
            color = "blue"
        else:
            verdict_short = "Not Recommended"
            verdict_desc = "Planetary conflict detected. Consult an expert."
            color = "red"

        # 2. Manglik Text
        is_match_manglik = (b_mang == g_mang)
        manglik_text = "Clean & Safe" if is_match_manglik else "Dosha Mismatch"

        # 3. Friendship (Bhakoot)
        bhakoot_score = breakdown['Bhakoot']
        friendship_text = "Best Friends" if bhakoot_score == 7 else "Average Bond"

        # 4. Health (Nadi)
        nadi_score = breakdown['Nadi']
        health_text = "Perfect Match" if nadi_score == 8 else "Consult Astrologer"

        # --- DISPLAY RESULTS ---
        st.divider()
        st.subheader(f"Results for {b_name} & {g_name}")

        # Big Score Card
        st.markdown(f"""
        <div style="text-align: center; padding: 20px; background-color: #f0f2f6; border-radius: 10px; margin-bottom: 20px;">
            <h2 style="color: {color}; margin:0;">{verdict_short}</h2>
            <p style="font-size: 18px;">Score: <b>{total} / 36</b></p>
            <p style="color: grey;">{verdict_desc}</p>
        </div>
        """, unsafe_allow_html=True)

        # UPDATED LAYOUT: 2 Rows x 2 Columns (Fixes readability)
        row1_c1, row1_c2 = st.columns(2)
        row1_c1.metric("Manglik Status", manglik_text, help="Checks for Mars Dosha")
        row1_c2.metric("Emotional Bond", friendship_text, help="Based on Bhakoot")

        row2_c1, row2_c2 = st.columns(2)
        row2_c1.metric("Health/Genes", health_text, help="Based on Nadi")
        row2_c2.metric("Temperament", f"{breakdown['Gana']} / 6", help="Based on Gana")

        # Detailed Expander
        with st.expander("See Detailed Breakdown"):
            st.write(f"**Boy's Timezone:** {b_data['timezone_used']} | **Girl's Timezone:** {g_data['timezone_used']}")
            st.table(breakdown)

    else:
        st.warning("Please fill in all Date and Time fields to proceed.")