# -*- coding: utf-8 -*-
"""AppAstro

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1pyvKmVGMTElSlb3eaxD-9j7DISurV1Qa
"""

# =========================================================
# YUGMA ‚Äî DATING FIRST, MARRIAGE UPGRADE READY
# =========================================================

import streamlit as st
import swisseph as swe
from geopy.geocoders import MapBox
from datetime import datetime, time as dt_time
from timezonefinder import TimezoneFinder
import pytz
import random
import google.generativeai as genai

# ---------------------------------------------------------
# CONFIG
# ---------------------------------------------------------
st.set_page_config(
    page_title="Yugma",
    page_icon="üß°",
    layout="centered"
)

MAPBOX_KEY = "pk.eyJ1IjoiY3JhYW0iLCJhIjoiY21qdmwycGtpMmJrdzNlc2RyeGh4NzI0ZCJ9.QDE8TkUAQFswm2XFBBxxaw"

# ---------------------------------------------------------
# SESSION STATE
# ---------------------------------------------------------
defaults = {
    "page": "Onboarding",
    "user": None,
    "profiles": [],
    "ai_bio": ""
}
for k, v in defaults.items():
    if k not in st.session_state:
        st.session_state[k] = v
# ---------------------------------------------------------
# SESSION STATE (GLOBAL ‚Äì DO NOT MOVE)
# ---------------------------------------------------------
if "page" not in st.session_state:
    st.session_state.page = "Onboarding"

if "user_profile" not in st.session_state:
    st.session_state.user_profile = None

if "profiles" not in st.session_state:
    st.session_state.profiles = []

# ‚úÖ THIS IS WHERE liked_profiles IS ADDED
if "liked_profiles" not in st.session_state:
    st.session_state.liked_profiles = []

if "generated_bio" not in st.session_state:
    st.session_state.generated_bio = ""

# ---------------------------------------------------------
# STYLES
# ---------------------------------------------------------
st.markdown("""
<style>
.stApp { background:#fffaf0; }
.card {
    background:white;
    border-radius:14px;
    padding:16px;
    margin-bottom:18px;
    box-shadow:0 4px 12px rgba(0,0,0,.06);
}
.badge {
    display:inline-block;
    background:#ffeaa7;
    color:#d35400;
    padding:4px 8px;
    border-radius:8px;
    font-size:12px;
    margin:2px;
}
.scorecard {
    border:2px dashed #e17055;
    padding:16px;
    border-radius:12px;
    background:#fff;
    font-family:monospace;
}
</style>
""", unsafe_allow_html=True)

# ---------------------------------------------------------
# LOCATION UTILS (MAPBOX ‚Äì NO HARDCODE)
# ---------------------------------------------------------
@st.cache_data(show_spinner=False)
def get_coords(city_name: str):
    if not city_name:
        return None, None
    try:
        geolocator = MapBox(
            api_key=MAPBOX_KEY,
            user_agent="yugma_dating_app_v1"
        )
        location = geolocator.geocode(city_name, timeout=10)
        if location:
            return location.latitude, location.longitude
        return None, None
    except:
        return None, None

# ---------------------------------------------------------
# VEDIC MATCH ENGINE (UNCHANGED CORE LOGIC)
# ---------------------------------------------------------
class VedicMatchEngine:
    def __init__(self):
        swe.set_ephe_path('')
        self.nak_to_nadi = [0,1,2,2,1,0,0,1,2,0,1,2,2,1,0,0,1,2,0,1,2,2,1,0,0,1,2]
        self.nak_to_gana = [0,1,2,1,0,1,0,0,0,2,1,1,2,2,2,2,0,0,2,1,1,0,2,2,1,0,0]
        self.rashi_lords = [2,5,3,1,0,3,5,2,4,6,6,4]
        self.maitri_matrix = [
            [5,5,5,4,5,0,0],[5,5,4,1,4,0.5,0.5],[5,4,5,0.5,5,3,0.5],
            [4,1,0.5,5,0.5,5,4],[5,4,5,0.5,5,0.5,3],[0,0.5,3,5,0.5,5,5],
            [0,0.5,0.5,4,3,5,5]
        ]

    def get_planet_data(self, dt_obj, lat, lon):
        tf = TimezoneFinder()
        tz = tf.timezone_at(lat=lat, lng=lon) or "UTC"
        local = pytz.timezone(tz).localize(dt_obj)
        utc = local.astimezone(pytz.utc)

        jd = swe.julday(
            utc.year, utc.month, utc.day,
            utc.hour + utc.minute / 60
        )
        swe.set_sid_mode(swe.SIDM_LAHIRI)

        moon = swe.calc_ut(jd, swe.MOON, swe.FLG_SIDEREAL)[0][0]
        mars = swe.calc_ut(jd, swe.MARS, swe.FLG_SIDEREAL)[0][0]

        return {
            "nakshatra": int(moon / 13.333333),
            "rashi": int(moon / 30),
            "mars_deg": mars
        }

    def calculate_match(self, boy, girl):
        # Dating-safe scoring
        dist = abs(boy["nakshatra"] - girl["nakshatra"])
        vibe = max(0, 100 - (dist * 3))

        maitri = (
            self.maitri_matrix[self.rashi_lords[boy["rashi"]]][self.rashi_lords[girl["rashi"]]] +
            self.maitri_matrix[self.rashi_lords[girl["rashi"]]][self.rashi_lords[boy["rashi"]]]
        ) / 2

        manglik_clash = abs(boy["mars_deg"] - girl["mars_deg"]) < 25
        flag = "‚ö†Ô∏è Intensity Clash" if manglik_clash else "‚úÖ Balanced"

        return int(vibe + maitri * 5), flag

# ---------------------------------------------------------
# AI HELPERS (GEMINI FREE TIER SAFE)
# ---------------------------------------------------------
def ai_bio(api_key, text):
    if not api_key:
        return text
    try:
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel("gemini-1.5-flash")
        prompt = f"""
Rewrite this dating bio in a cool Indian Gen Z tone.
No astrology words. Max 3 lines.

Bio: {text}
"""
        return model.generate_content(prompt).text.strip()
    except:
        return text

def ai_scorecard(api_key, a, b, score, flag):
    if not api_key:
        return f"""
üî• Vibe: Mixed
üö© Flag: {flag}
‚òï Tea: Depends on effort
‚≠ê Rating: {score//10}/10
"""
    try:
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel("gemini-1.5-flash")
        prompt = f"""
Create a viral dating scorecard.

Names: {a}, {b}
Score: {score}/100
Flag: {flag}

Format:
üî• Vibe:
‚úÖ Strength:
üö© Warning:
‚òï Tea:
‚≠ê Rating:
"""
        return model.generate_content(prompt).text
    except:
        return "AI unavailable."

# ---------------------------------------------------------
# DUMMY PROFILES
# ---------------------------------------------------------
def generate_profiles(gender):
    names = ["Aarav","Kabir","Rohan"] if gender=="Female" else ["Diya","Mira","Ananya"]
    img_m = "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d"
    img_f = "https://images.unsplash.com/photo-1544005313-94ddf0286df2"

    profiles=[]
    for i in range(10):
        profiles.append({
            "id":i,
            "name":random.choice(names),
            "age":random.randint(23,32),
            "city":random.choice(["Chennai","Bangalore","Mumbai"]),
            "img": img_m if gender=="Female" else img_f,
            "dob": datetime(1994, random.randint(1,12), random.randint(1,28)),
            "tob": dt_time(random.randint(0,23),0)
        })
    return profiles

# =========================================================
# ONBOARDING
# =========================================================
if not st.session_state.user:
    st.title("Welcome to Yugma üß°")

    name = st.text_input("Name")
    gender = st.selectbox("Gender", ["Male","Female"])
    dob = st.date_input("DOB", datetime(1996,1,1))
    tob = st.time_input("Time of Birth", dt_time(12,0))
    city = st.text_input("City")
    bio = st.text_area("Your Bio")
    api_key = st.text_input("Gemini API Key (optional)", type="password")

    if st.button("‚ú® Rewrite Bio with AI"):
        st.session_state.ai_bio = ai_bio(api_key, bio)

    if st.session_state.ai_bio:
        st.info(st.session_state.ai_bio)

    if st.button("Start Journey üöÄ"):
        lat, lon = get_coords(city)
        if not lat:
            st.error("Please enter a valid city")
        else:
            st.session_state.user = {
                "name": name,
                "gender": gender,
                "dob": dob,
                "tob": tob,
                "city": city,
                "lat": lat,
                "lon": lon,
                "bio": st.session_state.ai_bio or bio,
                "api": api_key
            }
            st.session_state.profiles = generate_profiles(gender)
            st.session_state.page = "Modes"
            st.experimental_rerun()

# =========================================================
# MODE SELECTION
# =========================================================
elif st.session_state.page == "Modes":
    st.title("Choose Path")

    # Navigation Cards
    st.markdown("<div class='card'><h3>‚ö° Swipeee</h3><p>Casual vibes. Just looks.</p></div>", unsafe_allow_html=True)
    if st.button("Play Swipeee"): st.session_state.page = "Swipeee"; st.rerun()

    st.markdown("<div class='card'><h3>üîÆ Yugma</h3><p>Astro-verified matches.</p></div>", unsafe_allow_html=True)
    if st.button("Enter Yugma"): st.session_state.page = "Yugma"; st.rerun()

    st.markdown("<div class='card'><h3>üíé Yugma+</h3><p>Marriage & Lineage Reports.</p></div>", unsafe_allow_html=True)
    if st.button("Unlock Plus"): st.session_state.page = "YugmaPlus"; st.rerun()

    st.markdown("<div class='card'><h3>‚öôÔ∏è Engine</h3><p>Manual Compatibility Check.</p></div>", unsafe_allow_html=True)
    if st.button("Open Engine"): st.session_state.page = "Engine"; st.rerun()

    st.markdown("<br>", unsafe_allow_html=True)
    if st.button("üë§ View My Profile"): st.session_state.page = "My Profile"; st.rerun()

# =========================================================
# SWIPEEE
# =========================================================
elif st.session_state.page=="Swipeee":
    st.title("Swipeee ‚ö°")
    for p in st.session_state.profiles:
        with st.container():
            st.markdown("<div class='card'>",unsafe_allow_html=True)
            st.image(p["img"],use_column_width=True)
            st.subheader(f"{p['name']}, {p['age']}")
            c1,c2=st.columns(2)
            c1.button("‚ùå", key=f"n{p['id']}")
            c2.button("üíö", key=f"y{p['id']}")
            st.markdown("</div>",unsafe_allow_html=True)
    st.button("‚Üê Back", on_click=lambda: st.session_state.update({"page":"Modes"}))

# =========================================================
# YUGMA (SMART DATING)
# =========================================================
elif st.session_state.page=="Yugma":
    st.title("Yugma üîÆ")
    engine = VedicMatchEngine()
    u = st.session_state.user

    u_data = engine.get_planet_data(
        datetime.combine(u["dob"],u["tob"]),
        u["lat"], u["lon"]
    )

    for p in st.session_state.profiles:
        plat, plon = get_coords(p["city"])
        if not plat:
            continue

        p_data = engine.get_planet_data(
            datetime.combine(p["dob"],p["tob"]),
            plat, plon
        )

        score, flag = engine.calculate_match(u_data, p_data)

        with st.container():
            st.markdown("<div class='card'>",unsafe_allow_html=True)
            st.image(p["img"],use_column_width=True)
            st.subheader(f"{p['name']}, {p['age']}")
            st.markdown(f"<span class='badge'>Vibe {score}%</span> <span class='badge'>{flag}</span>",unsafe_allow_html=True)

            if st.button("‚ú® Analyze", key=f"a{p['id']}"):
                card = ai_scorecard(u["api"], u["name"], p["name"], score, flag)
                st.markdown(f"<div class='scorecard'>{card}</div>",unsafe_allow_html=True)
            st.markdown("</div>",unsafe_allow_html=True)

    st.button("‚Üê Back", on_click=lambda: st.session_state.update({"page":"Modes"}))

# ====================================================
# 12. VIEW: YUGMA+ & PROFILE
# ====================================================
elif st.session_state.page == "YugmaPlus":
    st.title("Yugma +")
    if st.button("‚Üê Back"): st.session_state.page = "Modes"; st.rerun()

    st.markdown("""
    <div class='card'>
        <h3>üíé Premium Unlocked</h3>
        <p><b>Detailed Lineage Check:</b><br>Analyze ancestral compatibility.</p>
        <hr>
        <p><b>Marriage Timing:</b><br>Know exactly when the stars align.</p>
    </div>
    """, unsafe_allow_html=True)
    st.markdown("<div class='card'><h3>‚Çπ299 / month</h3></div>", unsafe_allow_html=True)
    if st.button("Subscribe Now"): st.balloons(); st.success("Welcome!")

elif st.session_state.page == "My Profile":
    st.title("My Profile")
    if st.button("‚Üê Back"): st.session_state.page = "Modes"; st.rerun()
    p = st.session_state.user_profile
    st.markdown(f"""
    <div class='card'>
        <h3>{p['name']}</h3>
        <p>üìç {p['pob']}</p>
        <p>üéÇ {p['dob'].strftime('%d %B %Y')}</p>
    </div>
    """, unsafe_allow_html=True)
    if st.button("Logout"): st.session_state.clear(); st.rerun()

# =========================================================
# PROFILE
# =========================================================
elif st.session_state.page=="Profile":
    u = st.session_state.user
    st.title("My Profile")
    st.write(f"**Name:** {u['name']}")
    st.write(f"**City:** {u['city']}")
    st.write(f"**Bio:** {u['bio']}")
    st.button("‚Üê Back", on_click=lambda: st.session_state.update({"page":"Modes"}))

# =========================================================
# MANUAL ENGINE
# =========================================================
elif st.session_state.page=="Engine":
    st.title("Compatibility Engine üßÆ")
    engine = VedicMatchEngine()
    me = st.session_state.user

    name = st.text_input("Partner Name")
    dob = st.date_input("Partner DOB")
    tob = st.time_input("Partner Time", dt_time(12,0))
    city = st.text_input("Partner City")

    if st.button("Generate Score"):
        lat, lon = get_coords(city)
        if not lat:
            st.error("Invalid city")
        else:
            me_data = engine.get_planet_data(
                datetime.combine(me["dob"],me["tob"]),
                me["lat"], me["lon"]
            )
            p_data = engine.get_planet_data(
                datetime.combine(dob,tob),
                lat, lon
            )
            score, flag = engine.calculate_match(me_data, p_data)
            st.markdown(
                f"<div class='scorecard'>{ai_scorecard(me['api'], me['name'], name, score, flag)}</div>",
                unsafe_allow_html=True
            )

    st.button("‚Üê Back", on_click=lambda: st.session_state.update({"page":"Modes"}))


# ====================================================
# VIEW: YUGMA (MATCHES)
# ====================================================
elif st.session_state.page == "Yugma":
    st.title("Your Matches")

    if st.button("‚Üê Back"):
        st.session_state.page = "Modes"
        st.rerun()

    matches = st.session_state.liked_profiles

    if not matches:
        st.info("You haven't liked anyone yet. Start swiping üíö")
    else:
        for idx, p in enumerate(matches):
            with st.container():
                st.markdown("<div class='card'>", unsafe_allow_html=True)

                c1, c2 = st.columns([1, 2])

                with c1:
                    st.image(p["img"], use_column_width=True)

                with c2:
                    st.subheader(f"{p['name']}, {p['age']}")

                    # Temporary score (replace with engine later)
                    score = random.randint(18, 32)
                    st.write(f"**Compatibility Score:** {score}/36")
                    st.write("‚úÖ Strong emotional alignment")

                    if st.button(f"‚ú® Analyze {p['name']}", key=f"analyze_match_{idx}"):
                        with st.spinner("Reading the vibes..."):
                            viral_text = ai_scorecard(
                                api_key,
                                st.session_state.user_profile["name"],
                                p["name"],
                                score,
                                "Balanced"
                            )
                            st.markdown(
                                f"<div class='viral-card'>{viral_text.replace(chr(10), '<br>')}</div>",
                                unsafe_allow_html=True
                            )

                st.markdown("</div>", unsafe_allow_html=True)

