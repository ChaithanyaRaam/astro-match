# -*- coding: utf-8 -*-
"""AppAstro

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1pyvKmVGMTElSlb3eaxD-9j7DISurV1Qa
"""

import streamlit as st
import swisseph as swe
from geopy.geocoders import MapBox
from datetime import datetime
from timezonefinder import TimezoneFinder
import pytz
import time
import google.generativeai as genai
from PIL import Image
import os

# --- PAGE CONFIGURATION ---
st.set_page_config(
    page_title="Yugma",
    page_icon="üß°",
    layout="centered",
    initial_sidebar_state="collapsed"
)

# --- SESSION STATE ---
if 'step' not in st.session_state: st.session_state.step = 1
if 'match_data' not in st.session_state: st.session_state.match_data = {}
if 'lane' not in st.session_state: st.session_state.lane = "Connect"

# --- CSS: YUGMA BRANDING ---
st.markdown("""
    <style>
    .stApp { background-color: #fffaf0; } /* Soft Cream Background for Yugma */

    /* Top Nav Styling */
    .lane-nav {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        background: white;
        padding: 10px;
        border-radius: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* Mode B: The Reality Card */
    .reality-card {
        background-color: white;
        border: 1px solid #f3a683;
        border-radius: 15px;
        padding: 25px;
        text-align: left;
        margin-bottom: 15px;
        box-shadow: 0 4px 20px rgba(243, 166, 131, 0.15);
    }

    .strength-tag { color: #e15f41; font-weight: bold; letter-spacing: 0.5px; }
    .watchout-tag { color: #596275; font-weight: bold; letter-spacing: 0.5px; }

    /* Typography */
    h1 { font-family: 'Georgia', serif; color: #e15f41; }
    h2 { font-family: 'Helvetica Neue', sans-serif; color: #303952; }
    p { font-family: 'Helvetica Neue', sans-serif; color: #596275; }

    /* Buttons */
    .stButton>button {
        border-radius: 30px;
        height: 50px;
        font-weight: bold;
    }
    </style>
    """, unsafe_allow_html=True)

# --- LOGO HEADER ---
# Replace 'yugma_logo.png' with your actual filename if different
if os.path.exists("yugma_logo.png"):
    st.image("yugma_logo.png", width=200)
else:
    st.markdown("<h1>Yugma</h1>", unsafe_allow_html=True) # Fallback text if image missing

# --- SIDEBAR (Settings) ---
with st.sidebar:
    st.header("‚öôÔ∏è Yugma Core")
    api_key = st.text_input("Gemini API Key", type="password")

    st.divider()
    if st.button("Reset Experience"):
        st.session_state.step = 1
        st.session_state.match_data = {}
        st.session_state.b_img = None
        st.session_state.g_img = None
        st.rerun()

# --- 1. THE LANE SWITCHER ---
c1, c2, c3 = st.columns([1,1,1])
with c1:
    if st.button("üç¨ Browse", use_container_width=True): st.session_state.lane = "Browse"
with c2:
    if st.button("üîÆ Connect", use_container_width=True): st.session_state.lane = "Connect"
with c3:
    if st.button("üíç Partner", use_container_width=True): st.session_state.lane = "Partner"

# Lane Description
if st.session_state.lane == "Browse":
    st.caption("MODE A: Casual Discovery (Visual & Fast)")
elif st.session_state.lane == "Connect":
    st.caption("MODE B: The Rational Bridge (Astro + Palmistry)")
else:
    st.caption("MODE C: Family & Values (The Checklist)")

st.divider()

# --- 2. ASTRO ENGINE (Backend) ---
class VedicMatchEngine:
    def __init__(self):
        swe.set_ephe_path('')
        self.nak_to_nadi = [0,1,2,2,1,0,0,1,2, 0,1,2,2,1,0,0,1,2, 0,1,2,2,1,0,0,1,2]
        self.nak_to_gana = [0,1,2,1,0,1,0,0,0, 2,1,1,2,2,2,2,0,0, 2,1,1,0,2,2,1,0,0]
        self.rashi_lords = [2, 5, 3, 1, 0, 3, 5, 2, 4, 6, 6, 4]
        self.nak_to_yoni = [0,1,2,3,3,4,5,2,5, 6,6,7,8,9,8,9,10,10, 4,11,13,11,12,0,12,7,1]
        self.yoni_matrix = [
            [4, 2, 2, 3, 2, 2, 2, 1, 0, 1, 3, 2, 0, 2], [2, 4, 3, 3, 2, 2, 2, 2, 3, 1, 2, 3, 0, 2],
            [2, 3, 4, 2, 1, 2, 1, 3, 3, 1, 2, 0, 3, 3], [3, 3, 2, 4, 2, 1, 1, 1, 1, 2, 2, 2, 0, 0],
            [2, 2, 1, 2, 4, 2, 1, 2, 2, 1, 0, 2, 1, 1], [2, 2, 2, 1, 2, 4, 0, 2, 2, 1, 2, 3, 3, 2],
            [2, 2, 1, 1, 1, 0, 4, 2, 2, 2, 2, 1, 2], [1, 2, 3, 1, 2, 2, 2, 4, 3, 0, 3, 2, 2, 1],
            [0, 3, 3, 1, 2, 2, 2, 3, 4, 1, 2, 3, 2, 2], [1, 1, 1, 2, 1, 1, 2, 0, 1, 4, 1, 1, 2, 1],
            [3, 2, 2, 2, 0, 2, 2, 3, 2, 1, 4, 2, 2, 2], [2, 3, 0, 2, 2, 3, 2, 2, 3, 1, 2, 4, 2, 2],
            [0, 0, 3, 0, 1, 3, 1, 2, 2, 2, 2, 2, 4, 2], [2, 2, 3, 0, 1, 2, 2, 1, 2, 1, 2, 2, 2, 4]
        ]
        self.maitri_matrix = [
             [5, 5, 5, 4, 5, 0, 0], [5, 5, 4, 1, 4, 0.5, 0.5], [5, 4, 5, 0.5, 5, 3, 0.5],
             [4, 1, 0.5, 5, 0.5, 5, 4], [5, 4, 5, 0.5, 5, 0.5, 3], [0, 0.5, 3, 5, 0.5, 5, 5],
             [0, 0.5, 0.5, 4, 3, 5, 5]
        ]

    def get_planet_data(self, dt_obj, lat, lon):
        tf = TimezoneFinder()
        timezone_str = tf.timezone_at(lng=lon, lat=lat) or 'UTC'
        local_tz = pytz.timezone(timezone_str)
        local_dt = local_tz.localize(dt_obj)
        utc_dt = local_dt.astimezone(pytz.utc)
        time_dec = utc_dt.hour + (utc_dt.minute / 60.0) + (utc_dt.second / 3600.0)
        jd = swe.julday(utc_dt.year, utc_dt.month, utc_dt.day, time_dec)
        swe.set_sid_mode(swe.SIDM_LAHIRI, 0, 0)
        cusps, ascmc = swe.houses(jd, lat, lon, b'P')
        asc_deg = cusps[0]
        planets = {
            "Sun": swe.calc_ut(jd, swe.SUN, swe.FLG_SIDEREAL)[0][0],
            "Moon": swe.calc_ut(jd, swe.MOON, swe.FLG_SIDEREAL)[0][0],
            "Mars": swe.calc_ut(jd, swe.MARS, swe.FLG_SIDEREAL)[0][0],
            "Jupiter": swe.calc_ut(jd, swe.JUPITER, swe.FLG_SIDEREAL)[0][0],
            "Venus": swe.calc_ut(jd, swe.VENUS, swe.FLG_SIDEREAL)[0][0],
            "Saturn": swe.calc_ut(jd, swe.SATURN, swe.FLG_SIDEREAL)[0][0],
            "Rahu": swe.calc_ut(jd, swe.MEAN_NODE, swe.FLG_SIDEREAL)[0][0]
        }
        planets["Ketu"] = (planets["Rahu"] + 180) % 360
        def get_rashi(deg): return int(deg / 30)
        def get_house(planet_deg, start_deg): return (int(planet_deg/30) - int(start_deg/30) + 12) % 12 + 1
        return {
            "nakshatra": int(planets["Moon"] / 13.333333),
            "rashi": get_rashi(planets["Moon"]),
            "planets_deg": planets,
            "asc_deg": asc_deg,
            "positions": {
                p: {
                    "Lagna": get_house(deg, asc_deg),
                    "Moon": get_house(deg, planets["Moon"]),
                    "Venus": get_house(deg, planets["Venus"]),
                    "Sign": get_rashi(deg)
                } for p, deg in planets.items()
            },
        }

    def calculate_papa_points(self, data):
        malefics = ["Sun", "Mars", "Saturn", "Rahu", "Ketu"]
        dosha_houses = [1, 2, 4, 7, 8, 12]
        total_points = 0
        for planet in malefics:
            pos = data['positions'][planet]
            if pos['Lagna'] in dosha_houses: total_points += 1
            if pos['Moon'] in dosha_houses: total_points += 1
            if pos['Venus'] in dosha_houses: total_points += 1
        return total_points

    def check_manglik_specifics(self, p_data):
        house = p_data['positions']['Mars']['Lagna']
        sign = p_data['positions']['Mars']['Sign']
        mars_deg = p_data['planets_deg']['Mars']
        is_manglik = house in [1, 2, 4, 7, 8, 12]
        if not is_manglik: return 0
        if sign in [0, 7, 9, 3]: return 1
        jup_deg = p_data['planets_deg']['Jupiter']
        if abs(mars_deg - jup_deg) < 15 or abs(mars_deg - jup_deg) > 345: return 1
        sun_deg = p_data['planets_deg']['Sun']
        if abs(mars_deg - sun_deg) < 10 or abs(mars_deg - sun_deg) > 350: return 1
        return 2

    def check_sarpa_dosha(self, p_data):
        rahu_house = p_data['positions']['Rahu']['Lagna']
        ketu_house = p_data['positions']['Ketu']['Lagna']
        rahu_deg = p_data['planets_deg']['Rahu']
        ketu_deg = p_data['planets_deg']['Ketu']
        jup_deg = p_data['planets_deg']['Jupiter']
        dosha_houses = [1, 2, 4, 7, 8, 12]
        has_sarpa = (rahu_house in dosha_houses) or (ketu_house in dosha_houses)
        if not has_sarpa: return 0
        if abs(rahu_deg - jup_deg) < 15 or abs(rahu_deg - jup_deg) > 345: return 1
        if abs(ketu_deg - jup_deg) < 15 or abs(ketu_deg - jup_deg) > 345: return 1
        return 2

    def calculate_match(self, boy, girl):
        scores = {'Varna': 1, 'Vashya': 2}
        dist = (girl['nakshatra'] - boy['nakshatra'] + 27) % 27
        scores['Tara'] = 3 if (dist % 9) not in [0,2,4,6] else 1.5
        scores['Yoni'] = self.yoni_matrix[self.nak_to_yoni[boy['nakshatra']]][self.nak_to_yoni[girl['nakshatra']]]
        scores['Maitri'] = (self.maitri_matrix[self.rashi_lords[boy['rashi']]][self.rashi_lords[girl['rashi']]] +
                            self.maitri_matrix[self.rashi_lords[girl['rashi']]][self.rashi_lords[boy['rashi']]]) / 2
        scores['Gana'] = 6 if self.nak_to_gana[boy['nakshatra']] == self.nak_to_gana[girl['nakshatra']] else 0
        dist_r = (girl['rashi'] - boy['rashi'] + 12) % 12
        scores['Bhakoot'] = 7 if dist_r in [0, 2, 3, 6, 9, 10] else 0
        scores['Nadi'] = 0 if self.nak_to_nadi[boy['nakshatra']] == self.nak_to_nadi[girl['nakshatra']] else 8
        total = sum(scores.values())
        b_mang = self.check_manglik_specifics(boy)
        g_mang = self.check_manglik_specifics(girl)
        b_sarpa = self.check_sarpa_dosha(boy)
        g_sarpa = self.check_sarpa_dosha(girl)
        b_papa = self.calculate_papa_points(boy)
        g_papa = self.calculate_papa_points(girl)
        return total, b_mang, g_mang, b_sarpa, g_sarpa, b_papa, g_papa, scores['Maitri'], scores['Nadi']

# --- 3. AI INSIGHT ENGINE (Palmistry Extraction) ---
def generate_reality_check(api_key, match_data, b_img_file=None, g_img_file=None):
    """
    1. Extracts Palm Traits from Images (if available).
    2. Combines with Astro data.
    3. Generates 2 Strengths, 1 Watchout, 1 Icebreaker.
    """
    if not api_key:
        return fallback_reality_check(match_data)

    try:
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('gemini-1.5-flash')

        # Prepare Prompt
        prompt = f"""
        Act as a modern relationship analyst for 'Yugma'.

        **Astro Data:**
        - Boy: {match_data['b_name']} (Interests: {', '.join(match_data['b_int'])})
        - Girl: {match_data['g_name']} (Interests: {', '.join(match_data['g_int'])})
        - Vedic Compatibility: {match_data['score']}/36
        - Red Flags: {match_data['flag_txt']}
        - Drama Level: {match_data['drama_txt']}

        **Instructions:**
        1. If palm images are provided below, ANALYZE THEM FIRST. Look for:
           - Heart Line (Curved=Emotional vs Straight=Logical)
           - Head Line (Long=Deep Thinker vs Short=Practical)
           - Hand Shape (Square=Earth/Stable vs Rectangular=Fire/Energetic)
        2. If no images, rely on Astro/Interests.

        **Output Format (Strictly 4 lines):**
        STRENGTH_1: [Deep insight based on Astro + Palm synergy]
        STRENGTH_2: [Another strong point]
        WATCHOUT: [A realistic friction point based on Red Flags or Palm clash]
        ICEBREAKER: [A fun question based on their interests]
        """

        inputs = [prompt]
        if b_img_file:
            inputs.append(Image.open(b_img_file))
            inputs.append("Image: Boy's Palm")
        if g_img_file:
            inputs.append(Image.open(g_img_file))
            inputs.append("Image: Girl's Palm")

        response = model.generate_content(inputs)
        text = response.text

        # Parse lines
        lines = [line.split(':', 1)[1].strip() for line in text.split('\n') if ':' in line]

        if len(lines) < 4: return fallback_reality_check(match_data)
        return lines

    except Exception as e:
        return fallback_reality_check(match_data)

def fallback_reality_check(data):
    strengths = []
    watchouts = []

    if data['score'] >= 20: strengths.append("Strong astrological foundation.")
    else: strengths.append("Challenging but exciting dynamic.")

    strengths.append(f"Shared interest in {data['b_int'][0] if data['b_int'] else 'growth'}.")

    if data['flag_txt'] != "Clean": watchouts.append("Potential ego clashes detected.")
    else: watchouts.append("Communication styles may differ.")

    icebreaker = f"Ask them: 'What's your wildest story about {data['g_int'][0] if data['g_int'] else 'travel'}?'"

    return [strengths[0], strengths[1], watchouts[0], icebreaker]

# --- 4. UTILS ---
@st.cache_data
def get_coords(city_name):
    known_cities = { "adoor": (9.1529, 76.7356), "chennai": (13.0827, 80.2707), "delhi": (28.7041, 77.1025), "mumbai": (19.0760, 72.8777) }
    clean = city_name.lower().split(',')[0].strip()
    if clean in known_cities: return known_cities[clean]
    try:
        geolocator = MapBox(api_key="pk.eyJ1IjoiY3JhYW0iLCJhIjoiY21qdmwycGtpMmJrdzNlc2RyeGh4NzI0ZCJ9.QDE8TkUAQFswm2XFBBxxaw", user_agent="astro_genz_v1")
        loc = geolocator.geocode(city_name)
        return (loc.latitude, loc.longitude) if loc else (None, None)
    except: return None, None

# --- 5. MAIN UI LOGIC ---

# ----------------- MODE A: BROWSE -----------------
if st.session_state.lane == "Browse":
    st.markdown("<h2 style='text-align: center;'>Explore Vibes</h2>", unsafe_allow_html=True)
    st.image("https://images.unsplash.com/photo-1517841905240-472988babdf9", use_column_width=True)
    c1, c2 = st.columns(2)
    c1.button("‚ùå Pass", use_container_width=True)
    c2.button("üíö Like", use_container_width=True)

# ----------------- MODE C: PARTNER -----------------
elif st.session_state.lane == "Partner":
    st.markdown("<h2 style='text-align: center;'>Family Mode</h2>", unsafe_allow_html=True)
    st.info("üîí Identity Verification Required for Yugma Partner.")
    st.text_input("Enter Government ID")
    st.button("Unlock Deep Compatibility")

# ----------------- MODE B: CONNECT (Core) -----------------
elif st.session_state.lane == "Connect":

    interests_list = ["Travel", "Gym", "Art", "Crypto", "Gaming", "Foodie", "Deep Talks", "Music", "Tech"]

    # --- STEP 1: ATTRACTION (Input / Profile View) ---
    if st.session_state.step == 1:
        st.markdown("### 1. The Setup")

        with st.expander("Your Profile (Him)", expanded=True):
            c1, c2 = st.columns(2)
            b_name = c1.text_input("Name", "X", key="b1")
            b_date = c1.date_input("DOB", datetime(1959, 12, 24), key="b2")
            b_time = c1.time_input("Time", datetime.strptime("06:34", "%H:%M").time(), key="b3")
            b_place = c1.text_input("City", "Adoor, India", key="b4")
            # CHANGED: No more manual traits. Only Image.
            b_img_up = c2.file_uploader("Palm Photo (Auto-Read)", type=['png', 'jpg'], key="b_img")
            b_int = c2.multiselect("Interests", interests_list, default=[interests_list[0]], key="b_i")

        with st.expander("Potential Match (Her)", expanded=True):
            c1, c2 = st.columns(2)
            g_name = c1.text_input("Name", "Y", key="g1")
            g_date = c1.date_input("DOB", datetime(1963, 2, 17), key="g2")
            g_time = c1.time_input("Time", datetime.strptime("09:04", "%H:%M").time(), key="g3")
            g_place = c1.text_input("City", "Chennai, India", key="g4")
            # CHANGED: No more manual traits. Only Image.
            g_img_up = c2.file_uploader("Palm Photo (Auto-Read)", type=['png', 'jpg'], key="g_img")
            g_int = c2.multiselect("Interests", interests_list, default=[interests_list[2]], key="g_i")

        if st.button("üíö Interested? Swipe Right", type="primary", use_container_width=True):
            with st.spinner("Calculating Yugma Score..."):
                b_lat, b_lon = get_coords(b_place)
                g_lat, g_lon = get_coords(g_place)

                if not b_lat:
                    st.error("Location Error")
                    st.stop()

                engine = VedicMatchEngine()
                b_d = engine.get_planet_data(datetime.combine(b_date, b_time), b_lat, b_lon)
                g_d = engine.get_planet_data(datetime.combine(g_date, g_time), g_lat, g_lon)

                score, b_mang, g_mang, b_sarpa, g_sarpa, b_papa, g_papa, maitri, nadi = engine.calculate_match(b_d, g_d)

                manglik_ok = (b_mang == g_mang) or (b_mang <= 1 and g_mang <= 1)
                sarpa_ok = (b_sarpa == g_sarpa) or (b_sarpa <= 1 and g_sarpa <= 1)
                if score >= 20:
                    if not sarpa_ok: sarpa_ok = True
                    if not manglik_ok and (b_mang <= 1 or g_mang <= 1): manglik_ok = True

                flag_txt = "Clean" if (manglik_ok and sarpa_ok) else "Dosha Mismatch"
                drama_txt = "High" if g_papa > (b_papa + 2) else "Low"

                # Save State (Traits removed from dict as they are now extracted by AI later)
                st.session_state.match_data = {
                    "score": int(score),
                    "flag_txt": flag_txt,
                    "drama_txt": drama_txt,
                    "b_int": b_int, "g_int": g_int,
                    "b_name": b_name, "g_name": g_name
                }
                st.session_state.b_img = b_img_up
                st.session_state.g_img = g_img_up
                st.session_state.step = 2
                st.rerun()

    # --- STEP 2: THE REALITY CHECK (Flip Card) ---
    elif st.session_state.step == 2:
        data = st.session_state.match_data

        with st.spinner("Yugma AI: Reading palms & aligning stars..."):
            insights = generate_reality_check(api_key, data, st.session_state.b_img, st.session_state.g_img)

        st.markdown("### 2. The Reality Check")
        st.caption("We looked past the profile picture. Here is the truth.")

        # The Card UI
        st.markdown(f"""
        <div class="reality-card">
            <h2 style="text-align: center; margin:0; color: #e15f41;">{data['score']}/36</h2>
            <p style="text-align: center; color: grey;">Yugma Compatibility</p>
            <hr style="border-top: 1px dashed #f3a683;">
            <p><span class="strength-tag">STRENGTH:</span> {insights[0]}</p>
            <p><span class="strength-tag">STRENGTH:</span> {insights[1]}</p>
            <p><span class="watchout-tag">WATCH OUT:</span> {insights[2]}</p>
            <hr style="border-top: 1px dashed #f3a683;">
            <p style="text-align: center;"><b>üí° Icebreaker</b><br><i>"{insights[3]}"</i></p>
        </div>
        """, unsafe_allow_html=True)

        # Step 2 Action: Confirm Intent
        c1, c2 = st.columns(2)
        if c1.button("üèÉ Run Away (Swipe Left)"):
            st.session_state.step = 1
            st.rerun()

        if c2.button("üî• Confirm Connection (Swipe Right)"):
            st.session_state.step = 3
            st.rerun()

    # --- STEP 3: INTENT CONFIRMATION ---
    elif st.session_state.step == 3:
        st.balloons()
        st.markdown(f"""
        <div style="text-align: center; padding: 40px;">
            <h1 style="color: #e15f41;">It's a Request! üíå</h1>
            <p>You passed the Reality Check. We've sent your profile to <b>{st.session_state.match_data['g_name']}</b>.</p>
        </div>
        """, unsafe_allow_html=True)

        if st.button("Browse More Profiles", use_container_width=True):
            st.session_state.step = 1
            st.rerun()